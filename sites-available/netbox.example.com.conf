# NetBox IPAM and DCIM Configuration
# Replace 'netbox.example.com' with your actual domain name
#
# Generate a self-signed certificate for testing:
# sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#   -keyout /etc/ssl/private/netbox.key \
#   -out /etc/ssl/certs/netbox.crt \
#   -subj "/CN=netbox.example.com"

# HTTP to HTTPS redirect
server {
    listen                  80;
    listen                  [::]:80;
    server_name             netbox.example.com;

    # Allow ACME challenge for Let's Encrypt
    include                 snippets/letsencrypt.conf;

    # Redirect all HTTP traffic to HTTPS
    location / {
        return              301 https://$server_name$request_uri;
    }
}

# Main NetBox HTTPS server
server {
    listen                  443 ssl;
    listen                  443 quic;
    listen                  [::]:443 ssl;
    listen                  [::]:443 quic;
    http2                   on;
    http3                   on;
    server_name             netbox.example.com;

    # SSL Configuration
    # For Let's Encrypt:
    # ssl_certificate         /etc/letsencrypt/live/netbox.example.com/fullchain.pem;
    # ssl_certificate_key     /etc/letsencrypt/live/netbox.example.com/privkey.pem;
    # ssl_trusted_certificate /etc/letsencrypt/live/netbox.example.com/chain.pem;

    # For self-signed certificate:
    ssl_certificate         /etc/ssl/certs/netbox.crt;
    ssl_certificate_key     /etc/ssl/private/netbox.key;

    # Include snippets
    include                 snippets/security-headers.conf;
    include                 snippets/gzip.conf;
    include                 snippets/http3.conf;
    include                 snippets/deny-files.conf;

    # Logging
    access_log              /var/log/nginx/netbox.access.log;
    error_log               /var/log/nginx/netbox.error.log warn;

    # Increase client body size for file uploads (device images, etc.)
    client_max_body_size    25M;

    # Optional: IP whitelist (uncomment and configure as needed)
    # allow 192.168.1.0/24;    # Local network
    # allow 10.0.0.0/8;        # Private network
    # deny all;

    # Proxy everything to NetBox - it handles its own routing, caching, and static files
    location / {
        proxy_pass              http://netbox_backend;
        include                 snippets/proxy-headers.conf;

        # Timeouts for slower operations (reports, exports, bulk operations)
        proxy_connect_timeout   30s;
        proxy_send_timeout      120s;
        proxy_read_timeout      120s;
    }

    # Health check endpoint (nginx-level, doesn't hit backend)
    location = /health {
        access_log off;
        include             snippets/security-headers.conf;
        add_header Content-Type "application/json" always;
        return 200 '{"status":"healthy","service":"netbox-proxy"}';
    }
}

# NetBox backend upstream
upstream netbox_backend {
    server 127.0.0.1:8001;
    # server netbox:8001;  # Use this if connecting via Docker network
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}
