# LibreNMS Network Monitoring System Configuration
# Replace 'librenms.example.com' with your actual domain name
# LibreNMS uses Laravel - all requests route through index.php

# HTTP to HTTPS redirect
server {
    listen                  80;
    listen                  [::]:80;
    server_name             librenms.example.com;

    include                 snippets/letsencrypt.conf;

    location / {
        return              301 https://$server_name$request_uri;
    }
}

# Main LibreNMS HTTPS server
server {
    listen                  443 ssl;
    listen                  443 quic;
    listen                  [::]:443 ssl;
    listen                  [::]:443 quic;
    http2                   on;
    http3                   on;
    server_name             librenms.example.com;

    # SSL Configuration
    ssl_certificate         /etc/letsencrypt/live/librenms.example.com/fullchain.pem;
    ssl_certificate_key     /etc/letsencrypt/live/librenms.example.com/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/librenms.example.com/chain.pem;

    include                 snippets/security-headers.conf;
    include                 snippets/http3.conf;

    # LibreNMS document root
    root                    /opt/librenms/html;
    index                   index.php;

    # Logging
    access_log              /var/log/nginx/librenms.access.log;
    error_log               /var/log/nginx/librenms.error.log warn;

    # File uploads and SNMP data
    client_max_body_size    50M;

    # Optional: IP whitelist
    # allow 192.168.1.0/24;
    # allow 10.0.0.0/8;
    # deny all;

    # Block sensitive files and directories
    location ~ ^/(\.git|\.env|\.htaccess|config|storage|bootstrap/cache|composer\.(json|lock)) {
        deny all;
        access_log off;
        log_not_found off;
    }

    # PHP processing with inlined fastcgi params
    location ~ \.php$ {
        try_files $uri =404;

        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_index index.php;

        # FastCGI params (inlined - no external file needed)
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
        fastcgi_param SCRIPT_NAME $fastcgi_script_name;
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param DOCUMENT_ROOT $document_root;
        fastcgi_param SERVER_PROTOCOL $server_protocol;
        fastcgi_param HTTPS $https if_not_empty;
        fastcgi_param REMOTE_ADDR $remote_addr;
        fastcgi_param REMOTE_PORT $remote_port;
        fastcgi_param SERVER_ADDR $server_addr;
        fastcgi_param SERVER_PORT $server_port;
        fastcgi_param SERVER_NAME $server_name;
        fastcgi_param HTTP_PROXY "";

        # Timeouts for polling, discovery, graphs
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 300s;
        fastcgi_read_timeout 300s;

        # Buffers for large responses
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
    }

    # Laravel routing - try file, then directory, then index.php
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Health check (nginx-level)
    location = /health {
        access_log off;
        include             snippets/security-headers.conf;
        add_header Content-Type "application/json" always;
        return 200 '{"status":"healthy","service":"librenms-proxy"}';
    }
}
