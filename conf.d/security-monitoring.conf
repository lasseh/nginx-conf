# =============================================================================
# SECURITY MONITORING - HTTP LEVEL
# =============================================================================
# HTTP-level directives for security monitoring (log formats, maps, rate limits)
# Include in nginx.conf http block: include conf.d/security-monitoring.conf;
# Then include snippets/security-monitoring.conf in server blocks for location rules
#
# Requires: conf.d/logformat.conf (loaded separately)

# =============================================================================
# SECURITY LOG FORMATS
# =============================================================================

# Security-focused log format for monitoring attacks and suspicious activity
# Includes additional fields useful for security analysis and fail2ban
log_format security_monitor '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   'rt=$request_time ua="$upstream_addr" '
                   'us="$upstream_status" ut="$upstream_response_time" '
                   'ul="$upstream_response_length" '
                   'cs=$upstream_cache_status';

# Detailed security log format with request ID for correlation
log_format security_detailed '$remote_addr - $remote_user [$time_local] '
                            '"$request" $status $body_bytes_sent '
                            '"$http_referer" "$http_user_agent" '
                            'request_id="$request_id" '
                            'request_time=$request_time '
                            'connection=$connection '
                            'connection_requests=$connection_requests';

# Custom log format for fail2ban parsing
log_format fail2ban '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent"';

# =============================================================================
# SUSPICIOUS ACTIVITY DETECTION MAPS
# =============================================================================

# Map common attack patterns for enhanced logging
map $request_uri $suspicious_request {
    default 0;
    ~*\.(php|asp|aspx|jsp)$ 1;  # Script file requests on non-script sites
    ~*/wp-admin 1;              # WordPress admin attempts
    ~*/admin 1;                 # Generic admin attempts
    ~*\.\./\.\. 1;             # Directory traversal attempts
    ~*union.*select 1;          # SQL injection attempts
    ~*<script 1;                # XSS attempts
    ~*eval\( 1;                 # Code injection attempts
}

# Map user agents that are commonly used by bots and scanners
map $http_user_agent $suspicious_ua {
    default 0;
    ~*nikto 1;
    ~*sqlmap 1;
    ~*nmap 1;
    ~*masscan 1;
    ~*zmap 1;
    # ~*curl 1;                 # Disabled: common in health checks and API clients
    # ~*wget 1;                 # Disabled: common in health checks and scripts
    # ~*python 1;               # Disabled: common in API clients (requests library)
    ~*scanner 1;
    ~*bot 1;
    "" 1;                       # Empty user agent
}

# =============================================================================
# RATE LIMITING ZONES FOR SECURITY (optional)
# =============================================================================

# Strict rate limiting for login endpoints
# limit_req_zone $binary_remote_addr zone=login:10m rate=1r/m;

# Rate limiting for API endpoints
# limit_req_zone $binary_remote_addr zone=api_strict:10m rate=10r/m;

# Rate limiting for search and heavy operations
# limit_req_zone $binary_remote_addr zone=search:10m rate=5r/m;
