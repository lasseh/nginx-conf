# =============================================================================
# NGINX MAP BLOCKS
# =============================================================================
# Global variable mappings used throughout the configuration
# These maps are processed at http level and available to all server blocks

# =============================================================================
# WEBSOCKET CONNECTION UPGRADE MAPPING
# =============================================================================
# Map the Upgrade header to determine connection type for WebSocket support
# RFC 6455 - The WebSocket Protocol
map $http_upgrade $connection_upgrade {
    default upgrade;    # If Upgrade header exists, set Connection to "upgrade"
    ''      close;      # If no Upgrade header, close the connection normally
}

# =============================================================================
# WEBSOCKET CLIENT IP FORWARDING (RFC 7239 COMPLIANT)
# =============================================================================
# Format client IP addresses for RFC 7239 Forwarded header
# Handles IPv4, IPv6, and Unix domain sockets correctly
map $remote_addr $proxy_forwarded_elem {
    # IPv4 addresses (standard format)
    ~^[0-9.]+$        "for=$remote_addr";

    # IPv6 addresses (bracketed and quoted per RFC 7239)
    ~^[0-9A-Fa-f:.]+$ "for=\"[$remote_addr]\"";

    # Unix domain sockets (cannot be represented in RFC 7239)
    default           "for=unknown";
}
