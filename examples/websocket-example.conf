# =============================================================================
# WEBSOCKET EXAMPLE CONFIGURATION
# =============================================================================
# Reference configuration for WebSocket proxying in nginx
# Copy relevant sections to your site configuration as needed
#
# NOTE: The map blocks are now in conf.d/maps.conf (loaded globally)
# You only need to copy location and upstream blocks from this file

# =============================================================================
# BASIC WEBSOCKET LOCATION BLOCK
# =============================================================================
# Simple WebSocket proxy - use this for most applications

location /websocket/ {
    proxy_pass http://websocket_backend;

    # Essential WebSocket headers (from conf.d/maps.conf)
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    # Standard proxy headers
    include snippets/proxy-headers.conf;

    # HTTP/1.1 required for the Upgrade handshake
    # conf.d/proxy.conf sets this globally, but include it explicitly
    # so the example works if copied to a server without that global config
    proxy_http_version                 1.1;

    # WebSocket is bidirectional — both directions need long timeouts
    proxy_read_timeout                 3600s;
    proxy_send_timeout                 3600s;
}

# =============================================================================
# ENTERPRISE WEBSOCKET LOCATION BLOCK
# =============================================================================
# For complex proxy chains requiring RFC 7239 compliance

location /websocket-enterprise/ {
    proxy_pass http://websocket_backend;

    # Essential WebSocket headers
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    # RFC 7239 compliant forwarding
    # Most backends use X-Forwarded-* (from proxy-headers.conf) instead.
    # Only add this if your backend specifically expects the Forwarded header.
    proxy_set_header Forwarded         "for=$remote_addr;host=$host;proto=$scheme";

    # Standard proxy headers
    include snippets/proxy-headers.conf;

    # HTTP/1.1 required for the Upgrade handshake
    proxy_http_version                 1.1;

    # WebSocket is bidirectional — both directions need long timeouts
    proxy_read_timeout                 3600s;
    proxy_send_timeout                 3600s;
}

# =============================================================================
# WEBSOCKET BACKEND DEFINITION
# =============================================================================

upstream websocket_backend {
    # WebSocket backend servers
    server backend1.example.com:8080;
    server backend2.example.com:8080;

    # Keep connections alive for WebSocket efficiency
    keepalive 32;

    # Use IP hash for session persistence if needed
    # ip_hash;
}

# =============================================================================
# USAGE INSTRUCTIONS
# =============================================================================
# 1. Map blocks ($connection_upgrade, $proxy_forwarded_elem) are in conf.d/maps.conf
# 2. Copy the location block you need to your site configuration
# 3. Copy the upstream block and customize your backend servers
# 4. For simple WebSocket: use the basic location block
# 5. For enterprise/CDN: use the enterprise location block with RFC 7239
# 6. Test with browser developer tools or wscat
#
# WHAT'S NOT NEEDED:
# - proxy_cache_bypass $http_upgrade — WebSocket connections aren't cacheable;
#   only relevant if a proxy_cache zone is active on this location
# - proxy_no_cache $http_upgrade — same reason
