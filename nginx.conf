# =============================================================================
# NGINX CONFIGURATION
# =============================================================================
# Modern, modular nginx configuration
# Architecture: Simple, secure, performant
#
# Directory structure:
#   conf.d/    - Global HTTP-level configs (loaded here)
#   snippets/  - Reusable blocks for server/location use
#   sites-*/   - Virtual host configurations
#
# Last updated: 2025-01-10

# =============================================================================
# PROCESS CONFIGURATION
# =============================================================================
user                       nginx;
pid                        /var/run/nginx.pid;
worker_processes           auto;              # One worker per CPU core
worker_rlimit_nofile       32768;             # Maximum open files per worker
worker_cpu_affinity        auto;              # Bind workers to CPU cores

# =============================================================================
# EVENTS
# =============================================================================
events {
    multi_accept           on;                # Accept multiple connections
    worker_connections     65535;             # Max connections per worker
}

# =============================================================================
# HTTP BLOCK
# =============================================================================
http {
    # =========================================================================
    # BASIC SETTINGS
    # =========================================================================
    charset                utf-8;
    sendfile               on;                # Efficient file transfers
    tcp_nopush             on;                # Optimize packet sending
    tcp_nodelay            on;                # Disable Nagle's algorithm
    server_tokens          off;               # Hide nginx version
    log_not_found          off;               # Don't log missing favicon, etc.
    types_hash_max_size    2048;
    types_hash_bucket_size 64;
    client_max_body_size   16M;               # Max upload size

    # =========================================================================
    # RATE LIMITING (Optional - comment out if not needed)
    # =========================================================================
    # Define rate limit zones for different endpoint types
    # Apply in location blocks with: limit_req zone=api burst=20 nodelay;
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=general:10m rate=1r/s;

    # =========================================================================
    # CONNECTION OPTIMIZATION
    # =========================================================================
    keepalive_timeout      65s;
    keepalive_requests     1000;
    keepalive_time         1h;

    # =========================================================================
    # MIME TYPES
    # =========================================================================
    include                conf.d/mime.types;
    default_type           application/octet-stream;

    # =========================================================================
    # LOGGING
    # =========================================================================
    include                conf.d/logformat.conf;  # Log format definitions
    access_log             /var/log/nginx/access.log;
    error_log              /var/log/nginx/error.log info;

    # =========================================================================
    # GLOBAL CONFIGURATIONS
    # =========================================================================
    # These are loaded at HTTP level and apply to all server blocks
    include                conf.d/maps.conf;              # Variable mappings (websocket, etc)
    include                conf.d/security.conf;          # Core security settings
    include                conf.d/performance.conf;       # Performance optimizations
    include                conf.d/proxy.conf;             # Proxy defaults (timeouts, buffering)
    include                conf.d/tls-intermediate.conf;  # TLS/SSL configuration
    # include              conf.d/cloudflare.conf;        # Cloudflare IP ranges (optional)

    # =========================================================================
    # VIRTUAL HOSTS
    # =========================================================================
    # Load enabled site configurations
    include                /etc/nginx/modules-enabled/*.conf;
    include                /etc/nginx/sites-enabled/*.conf;
}

# =============================================================================
# CONFIGURATION SUMMARY
# =============================================================================
#
# Architecture:
#   - conf.d/          Global HTTP-level configs (loaded above)
#   - snippets/        Reusable blocks (included in site configs)
#   - sites-available/ Site templates (not loaded)
#   - sites-enabled/   Active sites (symlinks, loaded above)
#   - html/errors/     Custom error pages
#
# Key Features:
#   - HTTP/2 enabled on all HTTPS sites
#   - No HTTP/3/QUIC (experimental, causes issues)
#   - Modular proxy headers via snippets/proxy-headers.conf
#   - Custom error pages for backend failures (502, 503, 504)
#   - Rate limiting zones defined (apply in locations as needed)
#   - WebSocket support via conf.d/maps.conf
#
# Usage:
#   - Add new sites to sites-available/
#   - Enable with: ln -s ../sites-available/site.conf sites-enabled/
#   - Test: nginx -t
#   - Reload: systemctl reload nginx
#
# =============================================================================
