# =============================================================================
# SECURITY MONITORING - SERVER LEVEL
# =============================================================================
# Location blocks for detecting and blocking common attack patterns
# Include in server blocks: include snippets/security-monitoring.conf;
#
# Prerequisite: conf.d/security-monitoring.conf must be loaded at HTTP level
# (provides log formats and map variables used by these location blocks)
#
# Add to nginx.conf:
#   include conf.d/security-monitoring.conf;
#
# Add to server blocks:
#   include snippets/security-monitoring.conf;

# =============================================================================
# ATTACK PATTERN DETECTION
# =============================================================================

# Block and log attempts to access script files (skip on script-based sites)
location ~* \.(php|asp|aspx|jsp)$ {
    access_log /var/log/nginx/security.log security_monitor;
    return 444;  # Close connection without response
}

# Block and log WordPress-specific attacks (skip on WordPress sites)
location ~* /wp-(admin|login|config|content) {
    access_log /var/log/nginx/security.log security_monitor;
    return 444;
}

# Block and log common admin panel probes
location ~* /(admin|administrator|phpmyadmin|pma) {
    access_log /var/log/nginx/security.log security_monitor;
    return 444;
}

# Block and log directory traversal attempts
location ~* \.\./\.\. {
    access_log /var/log/nginx/security.log security_monitor;
    return 444;
}

# =============================================================================
# USAGE
# =============================================================================
#
# 1. Enable HTTP-level config in nginx.conf:
#      include conf.d/security-monitoring.conf;
#
# 2. Include this file in server blocks:
#      include snippets/security-monitoring.conf;
#
# 3. Optionally log suspicious requests (uses map from conf.d):
#      if ($suspicious_request) {
#          access_log /var/log/nginx/security.log security_monitor;
#      }
#
# 4. Configure fail2ban with custom filters for /var/log/nginx/security.log
#
# Example fail2ban filter:
#   [Definition]
#   failregex = ^<HOST> -.*"(GET|POST|HEAD).*" (404|403|400|444) .*$
#   ignoreregex =
